local Players = game:GetService("Players")
local VirtualInputManager = game:GetService("VirtualInputManager")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local LogService = game:GetService("LogService")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local CONFIG = {
    typingSpeed = 0.08,
    minLength = 3,
    maxLength = 15,
    idealLength = 6,
    autoResetTime = 300,
    wordsPerPage = 15,
    learningMode = true,
    smartPrediction = true,
    autoType = false,
    autoDetect = true
}

local commonWords = {
    ["the"] = true, ["and"] = true, ["a"] = true, ["an"] = true,
    ["is"] = true, ["it"] = true, ["to"] = true, ["of"] = true,
    ["in"] = true, ["for"] = true, ["on"] = true, ["with"] = true,
    ["as"] = true, ["at"] = true, ["by"] = true, ["or"] = true,
}

local DICTIONARY_URLS = {
    "https://raw.githubusercontent.com/dwyl/english-words/refs/heads/master/words_dictionary.json",
    "https://raw.githubusercontent.com/first20hours/google-10000-english/master/google-10000-english-usa-no-swears.txt"
}

local allWords = {}
local collectedLetters = {}
local usedWords = {}
local lastWordTime = 0
local topWords = {}
local currentPage = 1

local wordStats = {}
local patternSuccess = {}
local totalAttempts = 0
local successfulWords = 0

-- Storage functions
local function loadLearningData()
    local success, data = pcall(function()
        return window.storage and window.storage.get("wordSearchStats")
    end)
    if success and data and data.value then
        local decoded = HttpService:JSONDecode(data.value)
        wordStats = decoded.wordStats or {}
        patternSuccess = decoded.patternSuccess or {}
        totalAttempts = decoded.totalAttempts or 0
        successfulWords = decoded.successfulWords or 0
        return true
    end
    return false
end

local function saveLearningData()
    pcall(function()
        if window.storage then
            local data = {
                wordStats = wordStats,
                patternSuccess = patternSuccess,
                totalAttempts = totalAttempts,
                successfulWords = successfulWords,
                lastUpdate = tick()
            }
            window.storage.set("wordSearchStats", HttpService:JSONEncode(data))
        end
    end)
end

local function recordWordSuccess(word, prefix)
    if not wordStats[word] then
        wordStats[word] = {uses = 0, success = 0, lastUsed = 0}
    end
    wordStats[word].uses = wordStats[word].uses + 1
    wordStats[word].success = wordStats[word].success + 1
    wordStats[word].lastUsed = tick()
    
    local pattern = prefix .. string.rep("_", #word - #prefix)
    if not patternSuccess[pattern] then
        patternSuccess[pattern] = {count = 0, words = {}}
    end
    patternSuccess[pattern].count = patternSuccess[pattern].count + 1
    table.insert(patternSuccess[pattern].words, word)
    
    successfulWords = successfulWords + 1
    totalAttempts = totalAttempts + 1
    
    saveLearningData()
end

local function getWordScore(word, prefix)
    local score = 0
    
    if wordStats[word] then
        score = score + (wordStats[word].success * 100)
        local recency = tick() - (wordStats[word].lastUsed or 0)
        if recency < 3600 then
            score = score + 50
        end
    end
    
    local lenDiff = math.abs(#word - CONFIG.idealLength)
    score = score + (10 - lenDiff * 2)
    
    local pattern = prefix .. string.rep("_", #word - #prefix)
    if patternSuccess[pattern] then
        score = score + (patternSuccess[pattern].count * 10)
    end
    
    return score
end

-- GUI Creation
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MegaWordSearchPro"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 340, 0, 480)
mainFrame.Position = UDim2.new(0.5, -170, 0.5, -240)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
mainFrame.BorderColor3 = Color3.fromRGB(0, 255, 255)
mainFrame.BorderSizePixel = 2
mainFrame.Active = true
mainFrame.Parent = screenGui

-- Mobile drag implementation
local dragging = false
local dragInput, dragStart, startPos

local function updateInput(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

mainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input == dragInput then
        updateInput(input)
    end
end)

local statsBar = Instance.new("TextLabel")
statsBar.Size = UDim2.new(1, -20, 0, 22)
statsBar.Position = UDim2.new(0, 10, 0, 10)
statsBar.BackgroundTransparency = 1
statsBar.TextColor3 = Color3.fromRGB(0, 255, 150)
statsBar.Font = Enum.Font.Gotham
statsBar.TextSize = 11
statsBar.Text = "üìä Success: 0/0 (0%)"
statsBar.TextXAlignment = Enum.TextXAlignment.Left
statsBar.Parent = mainFrame

local function updateStatsDisplay()
    local rate = totalAttempts > 0 and math.floor((successfulWords/totalAttempts)*100) or 0
    statsBar.Text = string.format("üìä Success: %d/%d (%d%%) | üíæ %d words", 
        successfulWords, totalAttempts, rate, #wordStats)
end

local searchBox = Instance.new("TextBox")
searchBox.Size = UDim2.new(1, -20, 0, 45)
searchBox.Position = UDim2.new(0, 10, 0, 37)
searchBox.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
searchBox.BorderColor3 = Color3.fromRGB(0, 255, 255)
searchBox.BorderSizePixel = 2
searchBox.TextColor3 = Color3.fromRGB(0, 255, 255)
searchBox.PlaceholderText = "Loading..."
searchBox.Font = Enum.Font.GothamBold
searchBox.TextSize = 22
searchBox.ClearTextOnFocus = false
searchBox.TextEditable = true
searchBox.Parent = mainFrame

local modeLabel = Instance.new("TextLabel")
modeLabel.Size = UDim2.new(1, -20, 0, 18)
modeLabel.Position = UDim2.new(0, 10, 0, 87)
modeLabel.BackgroundTransparency = 1
modeLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
modeLabel.Font = Enum.Font.GothamBold
modeLabel.TextSize = 10
modeLabel.Text = "üß† LEARNING MODE: ON | üéØ AUTO-DETECT: ON"
modeLabel.TextXAlignment = Enum.TextXAlignment.Left
modeLabel.Parent = mainFrame

local buttonFrame = Instance.new("Frame")
buttonFrame.Size = UDim2.new(1, -20, 0, 38)
buttonFrame.Position = UDim2.new(0, 10, 0, 110)
buttonFrame.BackgroundTransparency = 1
buttonFrame.Parent = mainFrame

local autoTypeButton = Instance.new("TextButton")
autoTypeButton.Size = UDim2.new(0.24, 0, 1, 0)
autoTypeButton.Position = UDim2.new(0, 0, 0, 0)
autoTypeButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
autoTypeButton.BorderColor3 = Color3.fromRGB(255, 0, 0)
autoTypeButton.BorderSizePixel = 2
autoTypeButton.TextColor3 = Color3.fromRGB(255, 0, 0)
autoTypeButton.Font = Enum.Font.GothamBold
autoTypeButton.TextSize = 11
autoTypeButton.Text = "AUTO\nOFF"
autoTypeButton.Parent = buttonFrame

local learnButton = Instance.new("TextButton")
learnButton.Size = UDim2.new(0.24, 0, 1, 0)
learnButton.Position = UDim2.new(0.25, 0, 0, 0)
learnButton.BackgroundColor3 = Color3.fromRGB(10, 50, 50)
learnButton.BorderColor3 = Color3.fromRGB(0, 255, 200)
learnButton.BorderSizePixel = 2
learnButton.TextColor3 = Color3.fromRGB(0, 255, 200)
learnButton.Font = Enum.Font.GothamBold
learnButton.TextSize = 11
learnButton.Text = "LEARN"
learnButton.Parent = buttonFrame

local trollButton = Instance.new("TextButton")
trollButton.Size = UDim2.new(0.24, 0, 1, 0)
trollButton.Position = UDim2.new(0.5, 0, 0, 0)
trollButton.BackgroundColor3 = Color3.fromRGB(50, 10, 50)
trollButton.BorderColor3 = Color3.fromRGB(255, 0, 255)
trollButton.BorderSizePixel = 2
trollButton.TextColor3 = Color3.fromRGB(255, 0, 255)
trollButton.Font = Enum.Font.GothamBold
trollButton.TextSize = 11
trollButton.Text = "TROLL"
trollButton.Parent = buttonFrame

local resetButton = Instance.new("TextButton")
resetButton.Size = UDim2.new(0.24, 0, 1, 0)
resetButton.Position = UDim2.new(0.75, 0, 0, 0)
resetButton.BackgroundColor3 = Color3.fromRGB(50, 50, 10)
resetButton.BorderColor3 = Color3.fromRGB(255, 255, 0)
resetButton.BorderSizePixel = 2
resetButton.TextColor3 = Color3.fromRGB(255, 255, 0)
resetButton.Font = Enum.Font.GothamBold
resetButton.TextSize = 11
resetButton.Text = "RESET"
resetButton.Parent = buttonFrame

local resultsFrame = Instance.new("ScrollingFrame")
resultsFrame.Size = UDim2.new(1, -20, 1, -210)
resultsFrame.Position = UDim2.new(0, 10, 0, 158)
resultsFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
resultsFrame.BorderColor3 = Color3.fromRGB(0, 255, 150)
resultsFrame.BorderSizePixel = 2
resultsFrame.ScrollBarThickness = 8
resultsFrame.Parent = mainFrame

local listLayout = Instance.new("UIListLayout")
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0, 3)
listLayout.Parent = resultsFrame

local arrowFrame = Instance.new("Frame")
arrowFrame.Size = UDim2.new(1, -20, 0, 35)
arrowFrame.Position = UDim2.new(0, 10, 1, -40)
arrowFrame.BackgroundTransparency = 1
arrowFrame.Parent = mainFrame

local leftArrow = Instance.new("TextButton")
leftArrow.Size = UDim2.new(0.48, 0, 1, 0)
leftArrow.Position = UDim2.new(0, 0, 0, 0)
leftArrow.Text = "‚óÄ"
leftArrow.Font = Enum.Font.GothamBold
leftArrow.TextSize = 20
leftArrow.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
leftArrow.TextColor3 = Color3.fromRGB(0, 255, 150)
leftArrow.BorderSizePixel = 0
leftArrow.Parent = arrowFrame

local rightArrow = Instance.new("TextButton")
rightArrow.Size = UDim2.new(0.48, 0, 1, 0)
rightArrow.Position = UDim2.new(0.52, 0, 0, 0)
rightArrow.Text = "‚ñ∂"
rightArrow.Font = Enum.Font.GothamBold
rightArrow.TextSize = 20
rightArrow.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
rightArrow.TextColor3 = Color3.fromRGB(0, 255, 150)
rightArrow.BorderSizePixel = 0
rightArrow.Parent = arrowFrame

local function notify(message)
    pcall(function()
        StarterGui:SetCore("SendNotification", {
            Title = "Smart Search",
            Text = message,
            Duration = 2
        })
    end)
end

local function extractLetters(message)
    local pattern = "Word:%s*([A-Z][A-Z]?[A-Z]?[A-Z]?[A-Z]?)"
    return string.match(message, pattern)
end

local function updateModeLabel()
    local learningText = CONFIG.learningMode and "LEARNING MODE: ON" or "BASIC MODE"
    local detectText = CONFIG.autoDetect and "AUTO-DETECT: ON" or "AUTO-DETECT: OFF"
    modeLabel.Text = string.format("üß† %s | üéØ %s", learningText, detectText)
end

-- Auto-detect words from console
LogService.MessageOut:Connect(function(message, messageType)
    if string.find(message, "Word:") and CONFIG.autoDetect then
        local letters = extractLetters(message)
        if letters then
            lastWordTime = tick()
            table.insert(collectedLetters, letters)
            searchBox.Text = letters
            notify("üéØ " .. letters .. " detected!")
        end
    end
end)

task.spawn(function()
    while task.wait(10) do
        if lastWordTime > 0 and tick() - lastWordTime > CONFIG.autoResetTime then
            usedWords = {}
            lastWordTime = 0
            notify("Auto-reset!")
        end
    end
end)

local function loadFromJSON(content)
    local success, wordsJson = pcall(function()
        return HttpService:JSONDecode(content)
    end)
    if not success then return false end
    for word, _ in pairs(wordsJson) do
        local len = #word
        if len >= CONFIG.minLength and len <= CONFIG.maxLength and not commonWords[word:lower()] then
            table.insert(allWords, word:lower())
        end
    end
    return true
end

local function loadFromText(content)
    for word in content:gmatch("[^\r\n]+") do
        local len = #word
        if len >= CONFIG.minLength and len <= CONFIG.maxLength and not commonWords[word:lower()] then
            table.insert(allWords, word:lower())
        end
    end
    return #allWords > 0
end

local function loadDictionary()
    notify("Loading dictionary...")
    for i, url in ipairs(DICTIONARY_URLS) do
        local ok, content = pcall(function()
            return game:HttpGet(url)
        end)
        if ok then
            local loaded = content:match("^%s*{") and loadFromJSON(content) or loadFromText(content)
            if loaded then
                searchBox.PlaceholderText = "Waiting for word..."
                loadLearningData()
                updateStatsDisplay()
                notify("‚úÖ Loaded " .. #allWords .. " words")
                return true
            end
        end
    end
    searchBox.PlaceholderText = "Load failed"
    notify("‚ùå Failed to load")
    return false
end

local function createWordLabel(text, score)
    local lbl = Instance.new("TextButton")
    lbl.Size = UDim2.new(1, 0, 0, 32)
    lbl.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    lbl.BorderSizePixel = 0
    lbl.TextColor3 = Color3.fromRGB(0, 255, 150)
    lbl.Font = Enum.Font.Gotham
    lbl.TextSize = 16
    
    local displayText = text:upper()
    if CONFIG.learningMode and score > 0 then
        local confidence = math.min(99, math.floor(score / 10))
        displayText = displayText .. string.format(" ‚≠ê%d%%", confidence)
    end
    
    lbl.Text = displayText
    lbl.Parent = resultsFrame
    return lbl
end

local function autoTypeWord(word, currentInput)
    if not CONFIG.autoType then return end
    
    local remaining = word:sub(#currentInput + 1)
    task.spawn(function()
        local cam = workspace.CurrentCamera
        local size = cam.ViewportSize
        local x, y = size.X/2, size.Y/2
        
        for _ = 1,3 do
            VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
            task.wait(0.05)
            VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
            task.wait(0.05)
        end
        
        for c in remaining:upper():gmatch(".") do
            VirtualInputManager:SendKeyEvent(true, Enum.KeyCode[c], false, game)
            task.wait(CONFIG.typingSpeed)
            VirtualInputManager:SendKeyEvent(false, Enum.KeyCode[c], false, game)
        end
        
        task.wait(0.15)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
    end)
end

local function displayPage()
    for _, c in ipairs(resultsFrame:GetChildren()) do
        if c:IsA("TextButton") then c:Destroy() end
    end
    local startIdx = (currentPage-1)*CONFIG.wordsPerPage + 1
    local endIdx = math.min(currentPage*CONFIG.wordsPerPage, #topWords)
    for i = startIdx, endIdx do
        local wordData = topWords[i]
        local word = wordData.word
        local score = wordData.score
        local lbl = createWordLabel(word, score)
        lbl.MouseButton1Click:Connect(function()
            if word then
                usedWords[word] = true
                recordWordSuccess(word, searchBox.Text:lower())
                updateStatsDisplay()
                notify("‚úÖ " .. word:upper())
                autoTypeWord(word, searchBox.Text)
                searchBox.Text = ""
            end
        end)
    end
    resultsFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
end

local function updateTopWords(input)
    topWords = {}
    input = input:lower()
    if input == "" then
        for _, c in ipairs(resultsFrame:GetChildren()) do
            if c:IsA("TextButton") then c:Destroy() end
        end
        return
    end
    
    for _, w in ipairs(allWords) do
        if w:sub(1, #input) == input and w ~= input and not usedWords[w] then
            local score = CONFIG.learningMode and getWordScore(w, input) or 0
            table.insert(topWords, {word = w, score = score})
        end
    end
    
    if CONFIG.learningMode then
        table.sort(topWords, function(a, b)
            if a.score == b.score then
                local lenA, lenB = #a.word, #b.word
                local distA = math.abs(lenA - CONFIG.idealLength)
                local distB = math.abs(lenB - CONFIG.idealLength)
                if distA == distB then
                    return lenA == lenB and a.word < b.word or lenA < lenB
                end
                return distA < distB
            end
            return a.score > b.score
        end)
    else
        table.sort(topWords, function(a, b)
            local lenA, lenB = #a.word, #b.word
            local distA = math.abs(lenA - CONFIG.idealLength)
            local distB = math.abs(lenB - CONFIG.idealLength)
            if distA == distB then
                return lenA == lenB and a.word < b.word or lenA < lenB
            end
            return distA < distB
        end)
    end
    
    currentPage = 1
    displayPage()
end

autoTypeButton.MouseButton1Click:Connect(function()
    CONFIG.autoType = not CONFIG.autoType
    if CONFIG.autoType then
        autoTypeButton.Text = "AUTO\nON"
        autoTypeButton.TextColor3 = Color3.fromRGB(0, 255, 0)
        autoTypeButton.BorderColor3 = Color3.fromRGB(0, 255, 0)
        notify("‚ö° Auto-type enabled")
    else
        autoTypeButton.Text = "AUTO\nOFF"
        autoTypeButton.TextColor3 = Color3.fromRGB(255, 0, 0)
        autoTypeButton.BorderColor3 = Color3.fromRGB(255, 0, 0)
        notify("Auto-type disabled")
    end
end)

learnButton.MouseButton1Click:Connect(function()
    CONFIG.learningMode = not CONFIG.learningMode
    if CONFIG.learningMode then
        learnButton.Text = "LEARN"
        learnButton.TextColor3 = Color3.fromRGB(0, 255, 200)
        learnButton.BorderColor3 = Color3.fromRGB(0, 255, 200)
        notify("üß† Learning enabled")
    else
        learnButton.Text = "BASIC"
        learnButton.TextColor3 = Color3.fromRGB(150, 150, 150)
        learnButton.BorderColor3 = Color3.fromRGB(100, 100, 100)
        notify("üìù Basic mode")
    end
    updateModeLabel()
    updateTopWords(searchBox.Text)
end)

trollButton.MouseButton1Click:Connect(function()
    if searchBox.Text == "" then
        notify("‚ö†Ô∏è Type letters first!")
        return
    end
    local input = searchBox.Text:lower()
    local longWords = {}
    for _, w in ipairs(allWords) do
        if w:sub(1, #input) == input and not usedWords[w] and #w >= 7 then
            table.insert(longWords, w)
        end
    end
    if #longWords == 0 then
        notify("‚ùå No long words!")
        return
    end
    table.sort(longWords, function(a, b) return #a > #b end)
    local trollWord = longWords[1]
    usedWords[trollWord] = true
    recordWordSuccess(trollWord, input)
    updateStatsDisplay()
    notify("üòà TROLL: " .. trollWord:upper())
    autoTypeWord(trollWord, searchBox.Text)
    searchBox.Text = ""
end)

resetButton.MouseButton1Click:Connect(function()
    usedWords = {}
    lastWordTime = 0
    notify("üîÑ Reset complete!")
end)

leftArrow.MouseButton1Click:Connect(function()
    if currentPage > 1 then
        currentPage = currentPage - 1
        displayPage()
    end
end)

rightArrow.MouseButton1Click:Connect(function()
    if currentPage < math.ceil(#topWords/CONFIG.wordsPerPage) then
        currentPage = currentPage + 1
        displayPage()
    end
end)

searchBox:GetPropertyChangedSignal("Text"):Connect(function()
    updateTopWords(searchBox.Text)
end)

task.spawn(function()
    if loadDictionary() then
        notify("üß† Smart mode ready!")
    end
end)
